name: éªŒè¯å’Œéƒ¨ç½²å­åŸŸåè¯·æ±‚

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'requests/**/*.json'
  push:
    branches: [main]
    paths:
      - 'requests/**/*.json'

env:
  PYTHON_VERSION: '3.9'

jobs:
  validate:
    name: éªŒè¯è¯·æ±‚
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: è·å–å˜æ›´çš„æ–‡ä»¶
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        files: requests/**/*.json
    
    - name: éªŒè¯è¯·æ±‚æ–‡ä»¶
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "æ£€æµ‹åˆ°å˜æ›´çš„è¯·æ±‚æ–‡ä»¶:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        
        validation_failed=false
        
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo ""
          echo "ğŸ” éªŒè¯æ–‡ä»¶: $file"
          echo "----------------------------------------"
          
          if python scripts/validate_request.py "$file"; then
            echo "âœ… $file éªŒè¯é€šè¿‡"
          else
            echo "âŒ $file éªŒè¯å¤±è´¥"
            validation_failed=true
          fi
        done
        
        if [ "$validation_failed" = true ]; then
          echo ""
          echo "âŒ éƒ¨åˆ†æ–‡ä»¶éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®æ­£"
          exit 1
        else
          echo ""
          echo "âœ… æ‰€æœ‰æ–‡ä»¶éªŒè¯é€šè¿‡"
        fi
    
    - name: æ£€æŸ¥åˆ é™¤çš„æ–‡ä»¶
      if: steps.changed-files.outputs.any_deleted == 'true'
      run: |
        echo "æ£€æµ‹åˆ°åˆ é™¤çš„æ–‡ä»¶:"
        echo "${{ steps.changed-files.outputs.deleted_files }}"
        
        # å°†åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œä¾›åç»­ä½œä¸šä½¿ç”¨
        echo "${{ steps.changed-files.outputs.deleted_files }}" > deleted_files.txt
    
    - name: ä¸Šä¼ åˆ é™¤æ–‡ä»¶åˆ—è¡¨
      if: steps.changed-files.outputs.any_deleted == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: deleted-files
        path: deleted_files.txt

  deploy:
    name: éƒ¨ç½² DNS è®°å½•
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: è·å–å˜æ›´çš„æ–‡ä»¶
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        files: requests/**/*.json
    
    - name: éƒ¨ç½²æ–°å¢/ä¿®æ”¹çš„è®°å½•
      if: steps.changed-files.outputs.any_changed == 'true'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        echo "éƒ¨ç½²å˜æ›´çš„è®°å½•:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo ""
          echo "ğŸš€ éƒ¨ç½²è®°å½•: $file"
          echo "----------------------------------------"
          
          if python scripts/deploy_dns.py deploy "$file"; then
            echo "âœ… $file éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ $file éƒ¨ç½²å¤±è´¥"
            exit 1
          fi
        done
    
    - name: ä¸‹è½½åˆ é™¤æ–‡ä»¶åˆ—è¡¨
      if: steps.changed-files.outputs.any_deleted == 'true'
      uses: actions/download-artifact@v3
      with:
        name: deleted-files
      continue-on-error: true
    
    - name: åˆ é™¤ DNS è®°å½•
      if: steps.changed-files.outputs.any_deleted == 'true'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        if [ -f deleted_files.txt ]; then
          echo "åˆ é™¤ DNS è®°å½•:"
          cat deleted_files.txt
          
          while IFS= read -r file; do
            if [ -n "$file" ] && [[ "$file" == requests/*.json ]]; then
              echo ""
              echo "ğŸ—‘ï¸ åˆ é™¤è®°å½•: $file"
              echo "----------------------------------------"
              
              # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥æ¨¡æ‹Ÿåˆ é™¤çš„è¯·æ±‚æ–‡ä»¶å†…å®¹
              # è¿™é‡Œæˆ‘ä»¬éœ€è¦ä» git å†å²ä¸­è·å–æ–‡ä»¶å†…å®¹
              git show HEAD~1:"$file" > temp_deleted_file.json 2>/dev/null || continue
              
              if python scripts/deploy_dns.py delete temp_deleted_file.json; then
                echo "âœ… $file å¯¹åº”çš„ DNS è®°å½•åˆ é™¤æˆåŠŸ"
              else
                echo "âŒ $file å¯¹åº”çš„ DNS è®°å½•åˆ é™¤å¤±è´¥"
              fi
              
              rm -f temp_deleted_file.json
            fi
          done < deleted_files.txt
        fi
    
    - name: æäº¤æ›´æ–°çš„åŸŸåè®°å½•
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git add domains/
          git commit -m "è‡ªåŠ¨æ›´æ–°åŸŸåè®°å½• [skip ci]" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          git push || echo "æ¨é€å¤±è´¥æˆ–æ²¡æœ‰æ›´æ”¹"
        fi

  comment:
    name: æ·»åŠ è¯„è®º
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: always() && github.event_name == 'pull_request'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ç”Ÿæˆè¯„è®ºå†…å®¹
      id: comment
      run: |
        comment=""
        
        if [ "${{ needs.validate.result }}" = "success" ]; then
          comment="## âœ… éªŒè¯é€šè¿‡\n\næ‚¨çš„å­åŸŸåç”³è¯·å·²é€šè¿‡éªŒè¯ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸å’Œåˆå¹¶ã€‚\n\n"
        else
          comment="## âŒ éªŒè¯å¤±è´¥\n\næ‚¨çš„å­åŸŸåç”³è¯·éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é—®é¢˜åé‡æ–°æäº¤ï¼š\n\n"
        fi
        
        # è·å–å˜æ›´æ–‡ä»¶å¹¶æ·»åŠ è¯¦ç»†ä¿¡æ¯
        files_changed="${{ needs.validate.outputs.changed-files }}"
        if [ -n "$files_changed" ]; then
          comment="${comment}### ğŸ“‹ æ£€æŸ¥çš„æ–‡ä»¶\n\n"
          for file in $files_changed; do
            comment="${comment}- \`$file\`\n"
          done
        fi
        
        comment="${comment}\n### ğŸ“– ä½¿ç”¨è¯´æ˜\n\n"
        comment="${comment}- è¯·ç¡®ä¿æ‚¨çš„ JSON æ–‡ä»¶æ ¼å¼æ­£ç¡®\n"
        comment="${comment}- å­åŸŸåä¸èƒ½ä¸ç°æœ‰è®°å½•å†²çª\n"
        comment="${comment}- GitHub è´¦æˆ·éœ€è¦æ»¡è¶³å¹´é¾„è¦æ±‚\n"
        comment="${comment}- æ¯ä¸ªç”¨æˆ·æœ€å¤šå¯ç”³è¯· 3 ä¸ªå­åŸŸå\n\n"
        comment="${comment}å¦‚æœ‰ç–‘é—®ï¼Œè¯·æŸ¥çœ‹ [ç”¨æˆ·æŒ‡å—](../blob/main/docs/USER_GUIDE.md) æˆ–æå‡º issueã€‚"
        
        # ä¿å­˜è¯„è®ºå†…å®¹
        echo -e "$comment" > comment.md
    
    - name: æ·»åŠ  PR è¯„è®º
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('comment.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
