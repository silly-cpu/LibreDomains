name: æ¯æ—¥å¥åº·æ£€æŸ¥

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 02:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  health-check:
    name: DNS å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: è¿è¡Œå¥åº·æ£€æŸ¥
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        python scripts/health_check.py --report-file health_report.md
    
    - name: ä¸Šä¼ å¥åº·æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: health-report
        path: health_report.md
    
    - name: åˆ›å»º Issueï¼ˆå¦‚æœæ£€æŸ¥å¤±è´¥ï¼‰
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let reportContent = '';
          
          try {
            reportContent = fs.readFileSync('health_report.md', 'utf8');
          } catch (error) {
            reportContent = 'å¥åº·æ£€æŸ¥æŠ¥å‘Šç”Ÿæˆå¤±è´¥';
          }
          
          const title = `ğŸš¨ DNS å¥åº·æ£€æŸ¥å¤±è´¥ - ${new Date().toLocaleDateString('zh-CN')}`;
          const body = `## å¥åº·æ£€æŸ¥å¤±è´¥\n\n${reportContent}\n\nè¯·æ£€æŸ¥ DNS è®°å½•å’Œ Cloudflare é…ç½®ã€‚\n\n> æ­¤ Issue ç”±è‡ªåŠ¨å¥åº·æ£€æŸ¥ç”Ÿæˆ`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['health-check', 'bug']
          });
