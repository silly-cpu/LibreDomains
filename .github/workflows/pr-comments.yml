name: PR è‡ªåŠ¨è¯„è®ºå’Œæ ‡ç­¾

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'requests/**/*.json'

jobs:
  auto-comment:
    name: è‡ªåŠ¨è¯„è®ºå’Œæ ‡ç­¾
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: è·å–å˜æ›´çš„æ–‡ä»¶
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        files: requests/**/*.json
    
    - name: éªŒè¯è¯·æ±‚å¹¶ç”Ÿæˆè¯„è®º
      id: validation
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ“‹ å¼€å§‹éªŒè¯è¯·æ±‚æ–‡ä»¶..."
        
        validation_results=""
        overall_status="success"
        error_count=0
        warning_count=0
        
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "ğŸ” éªŒè¯æ–‡ä»¶: $file"
          
          if python scripts/validate_request.py "$file" --verbose; then
            validation_results+="âœ… \`$file\` - éªŒè¯é€šè¿‡\n"
          else
            validation_results+="âŒ \`$file\` - éªŒè¯å¤±è´¥\n"
            overall_status="failure"
            error_count=$((error_count + 1))
          fi
        done
        
        # ç”Ÿæˆè¯„è®ºå†…å®¹
        comment="## ğŸ¤– è‡ªåŠ¨éªŒè¯ç»“æœ\n\n"
        
        if [ "$overall_status" = "success" ]; then
          comment+="### âœ… éªŒè¯é€šè¿‡\n\n"
          comment+="æ­å–œï¼æ‚¨çš„å­åŸŸåç”³è¯·å·²é€šè¿‡æ‰€æœ‰è‡ªåŠ¨éªŒè¯ã€‚\n\n"
        else
          comment+="### âŒ éªŒè¯å¤±è´¥\n\n"
          comment+="æŠ±æ­‰ï¼Œæ‚¨çš„ç”³è¯·ä¸­æœ‰ $error_count ä¸ªæ–‡ä»¶éªŒè¯å¤±è´¥ï¼Œè¯·ä¿®æ­£åé‡æ–°æäº¤ã€‚\n\n"
        fi
        
        comment+="### ğŸ“‹ éªŒè¯è¯¦æƒ…\n\n"
        comment+="$validation_results\n"
        
        comment+="### ğŸ“– å¸¸è§é—®é¢˜\n\n"
        comment+="- **JSON æ ¼å¼é”™è¯¯**: è¯·æ£€æŸ¥è¯­æ³•å’Œç¼ºå°‘çš„å­—æ®µ\n"
        comment+="- **å­åŸŸåå·²è¢«å ç”¨**: é€‰æ‹©å…¶ä»–åç§°\n"
        comment+="- **GitHub è´¦æˆ·è¦æ±‚**: è´¦æˆ·å¹´é¾„éœ€æ»¡ 30 å¤©\n"
        comment+="- **è®°å½•æ ¼å¼é”™è¯¯**: æ£€æŸ¥ IP åœ°å€æˆ–åŸŸåæ ¼å¼\n\n"
        
        comment+="### ğŸ”— æœ‰ç”¨é“¾æ¥\n\n"
        comment+="- [ç”¨æˆ·æŒ‡å—](../blob/main/docs/USER_GUIDE.md)\n"
        comment+="- [å¸¸è§é—®é¢˜](../blob/main/docs/FAQ.md)\n"
        comment+="- [ç¤ºä¾‹è¯·æ±‚](../tree/main/requests)\n\n"
        
        if [ "$overall_status" = "success" ]; then
          comment+="**ä¸‹ä¸€æ­¥**: ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸å’Œåˆå¹¶ ğŸš€"
        else
          comment+="**ä¸‹ä¸€æ­¥**: ä¿®æ­£é—®é¢˜åæ¨é€æ–°çš„æäº¤ ğŸ”§"
        fi
        
        # ä¿å­˜ç»“æœ
        echo "$comment" > comment.md
        echo "status=$overall_status" >> $GITHUB_OUTPUT
        echo "error_count=$error_count" >> $GITHUB_OUTPUT
    
    - name: æ·»åŠ  PR è¯„è®º
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('comment.md', 'utf8');
          
          // åˆ é™¤ä¹‹å‰çš„æœºå™¨äººè¯„è®º
          const comments = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          for (const comment_item of comments.data) {
            if (comment_item.user.type === 'Bot' && comment_item.body.includes('ğŸ¤– è‡ªåŠ¨éªŒè¯ç»“æœ')) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment_item.id,
              });
            }
          }
          
          // æ·»åŠ æ–°è¯„è®º
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: æ·»åŠ æ ‡ç­¾
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const status = '${{ steps.validation.outputs.status }}';
          const errorCount = parseInt('${{ steps.validation.outputs.error_count }}');
          
          // ç§»é™¤æ‰€æœ‰ç›¸å…³æ ‡ç­¾
          const labelsToRemove = ['âœ… validated', 'âŒ validation-failed', 'âš ï¸ needs-review', 'ğŸ”„ pending'];
          
          try {
            const currentLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            for (const label of currentLabels.data) {
              if (labelsToRemove.includes(label.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label.name,
                });
              }
            }
          } catch (error) {
            console.log('æ¸…ç†æ ‡ç­¾æ—¶å‡ºé”™:', error.message);
          }
          
          // æ·»åŠ æ–°æ ‡ç­¾
          const newLabels = [];
          
          if (status === 'success') {
            newLabels.push('âœ… validated');
            newLabels.push('âš ï¸ needs-review');
          } else {
            newLabels.push('âŒ validation-failed');
          }
          
          // æ ¹æ®é”™è¯¯æ•°é‡æ·»åŠ ä¼˜å…ˆçº§æ ‡ç­¾
          if (errorCount > 2) {
            newLabels.push('priority: high');
          }
          
          if (newLabels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: newLabels,
            });
          }

  welcome-comment:
    name: æ¬¢è¿æ–°è´¡çŒ®è€…
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: æ£€æŸ¥æ˜¯å¦ä¸ºé¦–æ¬¡è´¡çŒ®è€…
      id: check-contributor
      uses: actions/github-script@v6
      with:
        script: |
          const contributor = context.payload.pull_request.user.login;
          
          // æ£€æŸ¥æ˜¯å¦ä¸ºé¦–æ¬¡è´¡çŒ®è€…
          const { data: pullRequests } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            creator: contributor,
            state: 'all'
          });
          
          const isFirstTime = pullRequests.length === 1;
          
          return { isFirstTime, contributor };
    
    - name: æ¬¢è¿æ–°è´¡çŒ®è€…
      if: fromJSON(steps.check-contributor.outputs.result).isFirstTime
      uses: actions/github-script@v6
      with:
        script: |
          const contributor = '${{ fromJSON(steps.check-contributor.outputs.result).contributor }}';
          
          const welcomeMessage = `## ğŸ‰ æ¬¢è¿æ¥åˆ° LibreDomainsï¼
          
å—¨ @${contributor}ï¼Œ

æ„Ÿè°¢æ‚¨æäº¤ç¬¬ä¸€ä¸ªå­åŸŸåç”³è¯·ï¼æˆ‘ä»¬å¾ˆé«˜å…´çœ‹åˆ°æ–°æˆå‘˜åŠ å…¥æˆ‘ä»¬çš„ç¤¾åŒºã€‚

### ğŸ“‹ æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

1. **è‡ªåŠ¨éªŒè¯** ğŸ¤– - æˆ‘ä»¬çš„æœºå™¨äººä¼šæ£€æŸ¥æ‚¨çš„è¯·æ±‚æ ¼å¼
2. **äººå·¥å®¡æ ¸** ğŸ‘¥ - ç®¡ç†å‘˜ä¼šå®¡æŸ¥æ‚¨çš„ç”³è¯·
3. **DNS éƒ¨ç½²** ğŸš€ - å®¡æ ¸é€šè¿‡åè‡ªåŠ¨éƒ¨ç½²
4. **å…¨çƒç”Ÿæ•ˆ** ğŸŒ - 24-48å°æ—¶å†…å…¨çƒå¯è®¿é—®

### ğŸ”— æœ‰ç”¨èµ„æº

- [ç”¨æˆ·æŒ‡å—](../blob/main/docs/USER_GUIDE.md) - è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- [å¸¸è§é—®é¢˜](../blob/main/docs/FAQ.md) - è§£ç­”ç–‘æƒ‘
- [ç¤ºä¾‹æ–‡ä»¶](../tree/main/requests) - å‚è€ƒå…¶ä»–ç”³è¯·

### ğŸ’¬ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶ï¼š
- åœ¨è¿™ä¸ª PR ä¸­è¯„è®º
- [åˆ›å»º Issue](../issues/new) 
- æŸ¥çœ‹æˆ‘ä»¬çš„ [FAQ](../blob/main/docs/FAQ.md)

å†æ¬¡æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ğŸ™

---
*æ­¤æ¶ˆæ¯ç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿå‘é€*`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: welcomeMessage
          });
    
    - name: æ·»åŠ é¦–æ¬¡è´¡çŒ®è€…æ ‡ç­¾
      if: fromJSON(steps.check-contributor.outputs.result).isFirstTime
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: ['ğŸ‘‹ first-time-contributor']
          });

  merged-thanks:
    name: åˆå¹¶æ„Ÿè°¢
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    
    steps:
    - name: å‘é€æ„Ÿè°¢æ¶ˆæ¯
      uses: actions/github-script@v6
      with:
        script: |
          const contributor = context.payload.pull_request.user.login;
          
          const thanksMessage = `## ğŸ‰ ç”³è¯·å·²æ‰¹å‡†ï¼

æ­å–œ @${contributor}ï¼æ‚¨çš„å­åŸŸåç”³è¯·å·²æˆåŠŸåˆå¹¶ã€‚

### ğŸš€ éƒ¨ç½²çŠ¶æ€

æ‚¨çš„ DNS è®°å½•æ­£åœ¨éƒ¨ç½²ä¸­ã€‚è¯·æ³¨æ„ï¼š

- **ç«‹å³ç”Ÿæ•ˆ**: è®°å½•å·²æ·»åŠ åˆ° Cloudflare
- **å…¨çƒä¼ æ’­**: 24-48 å°æ—¶å†…å®Œå…¨ç”Ÿæ•ˆ
- **éªŒè¯æ–¹å¼**: ä½¿ç”¨ \`nslookup\` æˆ–åœ¨çº¿ DNS å·¥å…·æ£€æŸ¥

### ğŸ”§ ç®¡ç†æ‚¨çš„å­åŸŸå

- **æ›´æ–°è®°å½•**: ä¿®æ”¹åŸè¯·æ±‚æ–‡ä»¶å¹¶æäº¤æ–° PR
- **åˆ é™¤åŸŸå**: åˆ é™¤è¯·æ±‚æ–‡ä»¶å¹¶æäº¤ PR
- **æŠ€æœ¯æ”¯æŒ**: [åˆ›å»º Issue](../issues/new)

### ğŸ“Š é¡¹ç›®ç»Ÿè®¡

æ„Ÿè°¢æ‚¨æˆä¸ºæˆ‘ä»¬ç¤¾åŒºçš„ä¸€éƒ¨åˆ†ï¼æ‚¨æ˜¯ç¬¬ N ä½è·å¾—å­åŸŸåçš„ç”¨æˆ·ã€‚

---

**äº«å—æ‚¨çš„å…è´¹å­åŸŸåï¼** ğŸŠ

å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªé¡¹ç›®æœ‰ç”¨ï¼Œè¯·è€ƒè™‘ï¼š
- â­ ç»™é¡¹ç›®ç‚¹ä¸ªæ˜Ÿ
- ğŸ“¢ åˆ†äº«ç»™æœ‹å‹
- ğŸ¤ å¸®åŠ©å…¶ä»–ç”¨æˆ·

*æ­¤æ¶ˆæ¯ç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿå‘é€*`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: thanksMessage
          });
