name: çŠ¶æ€é¡µé¢è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    # æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡çŠ¶æ€é¡µé¢
    - cron: '0 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]
    paths:
      - 'domains/**/*.json'
      - 'config/**'

jobs:
  update-status:
    name: æ›´æ–°çŠ¶æ€é¡µé¢
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ç”ŸæˆçŠ¶æ€é¡µé¢
      run: |
        python scripts/status_generator.py --output STATUS.md
        python scripts/status_generator.py --metrics --metrics-file status/metrics.json
    
    - name: ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
      run: |
        mkdir -p reports
        python scripts/generate_stats.py --output reports/stats_$(date +%Y%m%d_%H%M).json --json
        python scripts/generate_stats.py --output reports/latest_stats.json --json
    
    - name: åˆ›å»ºçŠ¶æ€ç›®å½•
      run: |
        mkdir -p status
        
        # ç”ŸæˆçŠ¶æ€å¾½ç« æ•°æ®
        python -c "
        import json
        import sys
        sys.path.append('scripts')
        from generate_stats import StatisticsGenerator
        
        stats = StatisticsGenerator().generate_statistics()
        
        badges = {
          'total_domains': stats['summary']['total_domains'],
          'total_subdomains': stats['summary']['total_subdomains'],
          'total_users': stats['summary']['total_users'],
          'last_updated': '$(date -u +%Y-%m-%dT%H:%M:%SZ)'
        }
        
        with open('status/badges.json', 'w') as f:
            json.dump(badges, f, indent=2)
        "
    
    - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      id: changes
      run: |
        if git diff --quiet STATUS.md status/ reports/; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: æäº¤æ›´æ–°
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add STATUS.md status/ reports/
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°çŠ¶æ€é¡µé¢å’Œç»Ÿè®¡ä¿¡æ¯ [skip ci]" || exit 0
        git push

  health-check:
    name: å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: update-status
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: è¿è¡Œå¥åº·æ£€æŸ¥
      run: |
        mkdir -p reports/health
        python scripts/health_check.py --report-file reports/health/health_$(date +%Y%m%d_%H%M).md
        python scripts/health_check.py --json --report-file reports/health/health_latest.json
    
    - name: æ£€æŸ¥å¥åº·çŠ¶æ€
      id: health
      run: |
        if python scripts/health_check.py --json | jq -e '.summary.unhealthy_subdomains == 0' > /dev/null; then
          echo "healthy=true" >> $GITHUB_OUTPUT
        else
          echo "healthy=false" >> $GITHUB_OUTPUT
        fi
    
    - name: åˆ›å»ºå¥åº·é—®é¢˜ Issue
      if: steps.health.outputs.healthy == 'false'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // è¯»å–å¥åº·æ£€æŸ¥æŠ¥å‘Š
          const healthReport = fs.readFileSync('reports/health/health_latest.json', 'utf8');
          const health = JSON.parse(healthReport);
          
          const unhealthyCount = health.summary.unhealthy_subdomains;
          const title = `ğŸš¨ DNS å¥åº·æ£€æŸ¥å‘ç° ${unhealthyCount} ä¸ªå¼‚å¸¸å­åŸŸå`;
          
          let body = `## ğŸ” å¥åº·æ£€æŸ¥æŠ¥å‘Š\n\n`;
          body += `**æ£€æŸ¥æ—¶é—´**: ${health.timestamp}\n\n`;
          body += `**å¼‚å¸¸å­åŸŸåæ•°é‡**: ${unhealthyCount}\n\n`;
          body += `### ğŸ“‹ å¼‚å¸¸è¯¦æƒ…\n\n`;
          
          for (const [domain, report] of Object.entries(health.domain_reports)) {
            if (report.unhealthy_subdomains > 0) {
              body += `#### åŸŸå: ${domain}\n\n`;
              
              for (const subdomain of report.subdomain_reports) {
                if (!subdomain.healthy) {
                  body += `- **${subdomain.full_domain}**\n`;
                  body += `  - è®°å½•ç±»å‹: ${subdomain.record_type}\n`;
                  body += `  - è®°å½•å€¼: ${subdomain.record_value}\n`;
                  body += `  - é—®é¢˜: ${subdomain.issues.join(', ')}\n\n`;
                }
              }
            }
          }
          
          body += `### ğŸ”§ å»ºè®®æ“ä½œ\n\n`;
          body += `1. æ£€æŸ¥ DNS è®°å½•é…ç½®\n`;
          body += `2. éªŒè¯ç›®æ ‡æœåŠ¡å™¨çŠ¶æ€\n`;
          body += `3. è”ç³»ç›¸å…³ç”¨æˆ·ç¡®è®¤é—®é¢˜\n`;
          body += `4. å¦‚æœ‰å¿…è¦ï¼Œåˆ é™¤æ— æ•ˆè®°å½•\n\n`;
          body += `---\n*æ­¤ Issue ç”±è‡ªåŠ¨å¥åº·æ£€æŸ¥ç³»ç»Ÿåˆ›å»º*`;
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„ Issue
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'health-check,automated'
          });
          
          const existingIssue = issues.find(issue => 
            issue.title.includes('DNS å¥åº·æ£€æŸ¥å‘ç°') && 
            issue.title.includes('å¼‚å¸¸å­åŸŸå')
          );
          
          if (existingIssue) {
            // æ›´æ–°ç°æœ‰ Issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `## ğŸ”„ å¥åº·æ£€æŸ¥æ›´æ–°\n\n${body}`
            });
          } else {
            // åˆ›å»ºæ–° Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['health-check', 'automated', 'priority: high']
            });
          }
    
    - name: ä¸Šä¼ å¥åº·æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: health-report
        path: reports/health/
        retention-days: 30

  cleanup:
    name: æ¸…ç†æ—§æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [update-status, health-check]
    if: always()
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: æ¸…ç†æ—§æŠ¥å‘Šæ–‡ä»¶
      run: |
        # ä¿ç•™æœ€è¿‘30å¤©çš„æŠ¥å‘Š
        find reports/ -name "*.json" -type f -mtime +30 -delete 2>/dev/null || true
        find reports/ -name "*.md" -type f -mtime +30 -delete 2>/dev/null || true
        
        # ç¡®ä¿ä¿ç•™æœ€æ–°çš„æ–‡ä»¶
        ls -la reports/ || true
    
    - name: æäº¤æ¸…ç†ç»“æœ
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add reports/
          git commit -m "ğŸ§¹ æ¸…ç†æ—§æŠ¥å‘Šæ–‡ä»¶ [skip ci]" || exit 0
          git push
        fi
