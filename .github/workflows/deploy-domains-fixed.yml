name: éƒ¨ç½²åŸŸåé…ç½®

on:
  push:
    branches:
      - main
    paths:
      - 'domains/**/*.json'
      
  workflow_dispatch:
    inputs:
      force_all:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰åŸŸåé…ç½®'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    # æ·»åŠ ä»“åº“æ£€æŸ¥ï¼Œç¡®ä¿åªåœ¨ä¸»ä»“åº“è¿è¡Œ
    if: github.repository == 'bestzwei/LibreDomains' 
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
        
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: pip install requests dnspython
        
      - name: è·å–æ›´æ”¹çš„æ–‡ä»¶
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.force_all == 'false' }}
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: 'domains/**/*.json'
          separator: ' '
          since_last_remote_commit: true
      
      - name: è·å–æ‰€æœ‰åŸŸåæ–‡ä»¶
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_all == 'true' }}
        id: all-files
        run: |
          find domains -name "*.json" -not -name "example.json" > all_files.txt
          DOMAIN_FILES=$(cat all_files.txt | tr '\n' ' ')
          echo "files=$DOMAIN_FILES" >> $GITHUB_OUTPUT
          
      - name: è®¾ç½®éƒ¨ç½²æ–‡ä»¶
        id: deploy-files
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_all }}" == "true" ]; then
            FILES="${{ steps.all-files.outputs.files }}"
          else
            FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          fi
          echo "files=$FILES" >> $GITHUB_OUTPUT
      
      - name: éƒ¨ç½²åŸŸåé…ç½®
        if: steps.deploy-files.outputs.files != ''
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_EMAIL: ${{ secrets.CLOUDFLARE_EMAIL }}
        run: |
          # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "âŒ é”™è¯¯: CLOUDFLARE_API_TOKEN ç¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“çš„ Settings > Secrets and variables > Actions ä¸­æ·»åŠ  CLOUDFLARE_API_TOKEN"
            exit 1
          fi
          
          echo "âœ… Cloudflare API Token å·²é…ç½® (é•¿åº¦: ${#CLOUDFLARE_API_TOKEN})"
          
          # å¤„ç†æ¯ä¸ªæ–‡ä»¶
          for file in ${{ steps.deploy-files.outputs.files }}; do
            echo "å¤„ç†æ–‡ä»¶: $file"
            
            # æå–åŸŸåå’Œå­åŸŸå
            DOMAIN=$(echo $file | cut -d'/' -f2)
            SUBDOMAIN=$(basename $file .json)
            
            # è·³è¿‡ç¤ºä¾‹æ–‡ä»¶
            if [ "$SUBDOMAIN" == "example" ]; then
              echo "è·³è¿‡ç¤ºä¾‹æ–‡ä»¶"
              continue
            fi
            
            echo "åŸŸå: $DOMAIN, å­åŸŸå: $SUBDOMAIN"
            
            # é¦–å…ˆè¿è¡Œè°ƒè¯•æ¨¡å¼éªŒè¯æƒé™
            echo "=== éªŒè¯ API Token æƒé™ ==="
            if ! python scripts/cloudflare/cloudflare_manager.py \
              --api-key "$CLOUDFLARE_API_TOKEN" \
              $( [ -n "$CLOUDFLARE_EMAIL" ] && echo "--email $CLOUDFLARE_EMAIL" ) \
              --domain "$DOMAIN" \
              --subdomain "$SUBDOMAIN" \
              --action debug \
              --debug; then
              echo "âŒ API Token æƒé™éªŒè¯å¤±è´¥"
              echo "è¯·æ£€æŸ¥:"
              echo "1. API Token æ˜¯å¦æœ‰æ•ˆ"
              echo "2. API Token æ˜¯å¦æœ‰ Zone:Read å’Œ DNS:Edit æƒé™"
              echo "3. API Token æ˜¯å¦èƒ½è®¿é—®åŸŸå $DOMAIN çš„ Zone"
              exit 1
            fi
            
            echo "=== å¼€å§‹åŒæ­¥ DNS è®°å½• ==="
            # ç„¶åè¿è¡Œå®é™…åŒæ­¥
            if ! python scripts/cloudflare/cloudflare_manager.py \
              --api-key "$CLOUDFLARE_API_TOKEN" \
              $( [ -n "$CLOUDFLARE_EMAIL" ] && echo "--email $CLOUDFLARE_EMAIL" ) \
              --domain "$DOMAIN" \
              --subdomain "$SUBDOMAIN" \
              --json-file "$file" \
              --action sync \
              --debug; then
              echo "âŒ DNS è®°å½•åŒæ­¥å¤±è´¥: $file"
              echo "è¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯"
              exit 1
            else
              echo "âœ… DNS è®°å½•åŒæ­¥æˆåŠŸ: $file"
            fi
            
            echo "---"
          done
          
          echo "ğŸ‰ æ‰€æœ‰åŸŸåé…ç½®éƒ¨ç½²å®Œæˆ!"
