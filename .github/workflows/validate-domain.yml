name: éªŒè¯åŸŸåç”³è¯·

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'domains/**/*.json'
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'domains/**/*.json'

jobs:
  validate-domain:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      pull-requests: write  # å…è®¸å†™å…¥ PR è¯„è®º
      checks: write         # å…è®¸åˆ›å»ºæ£€æŸ¥çŠ¶æ€
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # å¯¹äº pull_request_targetï¼Œæ£€å‡º PR çš„ä»£ç 
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0
        
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: pip install requests dnspython
        
      - name: è·å–æ›´æ”¹çš„æ–‡ä»¶
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: 'domains/**/*.json'
          separator: ' '
          # å¯¹äº pull_request_targetï¼Œéœ€è¦æŒ‡å®š base å’Œ head
          base_sha: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.base.sha || '' }}
          sha: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || '' }}
      
      - name: éªŒè¯åŸŸåé…ç½®
        if: steps.changed-files.outputs.all_changed_files != ''
        id: validate
        run: |
          echo "=== å¼€å§‹éªŒè¯åŸŸåé…ç½® ==="
          echo "å·¥ä½œæµç±»å‹: ${{ github.event_name }}"
          echo "æ›´æ”¹çš„æ–‡ä»¶: ${{ steps.changed-files.outputs.all_changed_files }}"
          echo "PRä½œè€…: ${{ github.event.pull_request.user.login }}"
          echo "ä»“åº“: ${{ github.repository }}"
          echo ""
          
          # åˆ›å»ºè¾“å‡ºæ–‡ä»¶
          mkdir -p output
          
          # è¿è¡ŒéªŒè¯è„šæœ¬
          if python scripts/bot/pr_checker.py \
            --files ${{ steps.changed-files.outputs.all_changed_files }} \
            --pr-author "${{ github.event.pull_request.user.login }}" \
            --repo-owner "${{ github.repository_owner }}" \
            --repo-name "${{ github.event.repository.name }}" \
            --github-token "${{ secrets.GITHUB_TOKEN }}" \
            --output output/validation_result.md \
            --debug; then
            echo "validation_success=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ‰ æ‰€æœ‰åŸŸåé…ç½®éªŒè¯é€šè¿‡ï¼"
          else
            echo "validation_success=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ åŸŸåé…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚"
          fi
      
      - name: å‘å¸ƒ PR è¯„è®º (ä»…ä¸»ä»“åº“)
        if: github.event_name == 'pull_request_target' && steps.changed-files.outputs.all_changed_files != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'output/validation_result.md';
            
            if (fs.existsSync(path)) {
              const body = fs.readFileSync(path, 'utf8');
              
              // æŸ¥æ‰¾ç°æœ‰çš„æœºå™¨äººè¯„è®º
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.data.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ğŸ¤– åŸŸåé…ç½®éªŒè¯ç»“æœ')
              );
              
              if (botComment) {
                // æ›´æ–°ç°æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            }
      
      - name: è®¾ç½®æ£€æŸ¥çŠ¶æ€
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          if [ "${{ steps.validate.outputs.validation_success }}" == "true" ]; then
            echo "âœ… éªŒè¯é€šè¿‡ - PR å¯ä»¥åˆå¹¶"
            exit 0
          else
            echo "âŒ éªŒè¯å¤±è´¥ - PR éœ€è¦ä¿®å¤é—®é¢˜"
            exit 1
          fi
      
      - name: æ— æ–‡ä»¶æ›´æ”¹
        if: steps.changed-files.outputs.all_changed_files == ''
        run: |
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°åŸŸåé…ç½®æ–‡ä»¶çš„æ›´æ”¹ã€‚"
